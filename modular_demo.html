<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NormScout - Modular Compliance Analysis</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="modular_styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üîç</span>
                    <span class="logo-text">
                        <span class="logo-norm">Norm</span><span class="logo-scout">Scout</span>
                    </span>
                    <span style="margin-left: 10px; color: #666; font-size: 14px;">Modular API Demo</span>
                </div>
            </div>
        </div>
    </header>

    <main style="margin-top: 100px; padding: 20px;">
        <div class="container">
            <h1 style="text-align: center; color: #2048D5; margin-bottom: 40px;">
                Modular Compliance Analysis
            </h1>

            <!-- Input Section -->
            <div style="max-width: 800px; margin: 0 auto 40px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <input
                        type="text"
                        id="product-input"
                        class="demo-input"
                        placeholder="Enter product (e.g., Bluetooth Speaker)"
                        value="Bluetooth Speaker"
                    >
                    <select id="country-input" class="demo-input demo-select">
                        <option value="">Select Country</option>
                        <option value="us">United States</option>
                        <option value="eu" selected>European Union</option>
                        <option value="uk">United Kingdom</option>
                        <option value="ca">Canada</option>
                        <option value="au">Australia</option>
                        <option value="jp">Japan</option>
                        <option value="ch">Switzerland</option>
                    </select>
                </div>

                <!-- Query Type Selector -->
                <div class="query-type-selector">
                    <button class="query-type-btn active" data-type="parallel">
                        ‚ö° Parallel Query (Fast)
                    </button>
                    <button class="query-type-btn" data-type="progressive">
                        üìä Progressive Loading
                    </button>
                    <button class="query-type-btn" data-type="chain">
                        üîó Chained Query (Context-Aware)
                    </button>
                </div>

                <!-- Field Selector -->
                <div class="field-selector">
                    <div class="field-checkbox">
                        <input type="checkbox" id="field-safety" value="safety_standards" checked>
                        <label for="field-safety">Safety Standards</label>
                    </div>
                    <div class="field-checkbox">
                        <input type="checkbox" id="field-labeling" value="labeling_requirements" checked>
                        <label for="field-labeling">Labeling Requirements</label>
                    </div>
                    <div class="field-checkbox">
                        <input type="checkbox" id="field-import" value="import_documentation" checked>
                        <label for="field-import">Import Documentation</label>
                    </div>
                    <div class="field-checkbox">
                        <input type="checkbox" id="field-testing" value="testing_requirements" checked>
                        <label for="field-testing">Testing Requirements</label>
                    </div>
                    <div class="field-checkbox">
                        <input type="checkbox" id="field-substances" value="restricted_substances">
                        <label for="field-substances">Restricted Substances</label>
                    </div>
                    <div class="field-checkbox">
                        <input type="checkbox" id="field-packaging" value="packaging_requirements">
                        <label for="field-packaging">Packaging Requirements</label>
                    </div>
                    <div class="field-checkbox">
                        <input type="checkbox" id="field-environmental" value="environmental_compliance">
                        <label for="field-environmental">Environmental Compliance</label>
                    </div>
                    <div class="field-checkbox">
                        <input type="checkbox" id="field-surveillance" value="market_surveillance">
                        <label for="field-surveillance">Market Surveillance</label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button id="analyze-btn" class="btn btn-accent btn-large" style="min-width: 200px;">
                        üîç Analyze Selected Fields
                    </button>
                    <button id="clear-cache-btn" class="btn" style="background: #6c757d; color: white;">
                        üóëÔ∏è Clear Cache
                    </button>
                </div>
            </div>

            <!-- Progress Indicator -->
            <div id="progress-indicator"></div>

            <!-- Results Summary -->
            <div id="results-summary" style="display: none;"></div>

            <!-- Results Container -->
            <div id="results-container" class="compliance-fields-container"></div>

            <!-- Cache Info -->
            <div id="cache-info" style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px; font-family: monospace; font-size: 12px; color: #666;">
                Cache: <span id="cache-status">Empty</span>
            </div>
        </div>
    </main>

    <!-- Load Scripts -->
    <script src="functions.js"></script>
    <script src="compliance_api.js"></script>
    <script>
        // Initialize
        const api = new ComplianceAPI();
        let currentQueryType = 'parallel';

        // Query type selector
        document.querySelectorAll('.query-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.query-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentQueryType = this.dataset.type;
            });
        });

        // Get selected fields
        function getSelectedFields() {
            const checkboxes = document.querySelectorAll('.field-checkbox input:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Analyze button
        document.getElementById('analyze-btn').addEventListener('click', async function() {
            const product = document.getElementById('product-input').value;
            const country = document.getElementById('country-input').value;
            const fields = getSelectedFields();

            if (!product || !country || fields.length === 0) {
                alert('Please enter product, select country, and choose at least one field');
                return;
            }

            const button = this;
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> Analyzing...';
            button.disabled = true;

            const container = document.getElementById('results-container');
            const progressDiv = document.getElementById('progress-indicator');

            // Clear previous results
            container.innerHTML = '';
            progressDiv.innerHTML = '';

            let results;
            const startTime = Date.now();

            try {
                switch (currentQueryType) {
                    case 'parallel':
                        // Show all loading skeletons at once
                        container.innerHTML = fields.map(field =>
                            ComplianceUI.createLoadingSkeleton(api.fields[field] || field)
                        ).join('');

                        results = await api.queryParallel(fields, product, country);

                        // Replace all skeletons with results
                        container.innerHTML = '';
                        for (const field of fields) {
                            const result = results.results[field];
                            container.innerHTML += ComplianceUI.createFieldCard(
                                api.fields[field] || field,
                                result
                            );
                        }
                        break;

                    case 'progressive':
                        results = await api.queryProgressive(
                            fields,
                            product,
                            country,
                            (field, result, completed, total) => {
                                // Add or update field card
                                if (completed === 1) {
                                    container.innerHTML = '';
                                }
                                container.innerHTML += ComplianceUI.createFieldCard(
                                    api.fields[field] || field,
                                    result
                                );

                                // Update progress
                                progressDiv.innerHTML = ComplianceUI.createProgressIndicator(completed, total);
                            }
                        );
                        break;

                    case 'chain':
                        // Show loading skeletons
                        container.innerHTML = fields.map(field =>
                            ComplianceUI.createLoadingSkeleton(api.fields[field] || field)
                        ).join('');

                        results = await api.queryChain(fields, product, country);

                        // Replace with results
                        container.innerHTML = '';
                        for (const field of fields) {
                            const result = results.results[field];
                            container.innerHTML += ComplianceUI.createFieldCard(
                                api.fields[field] || field,
                                result
                            );
                        }
                        break;
                }

                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(1);

                // Show summary
                showResultsSummary(results, duration);

                // Update cache status
                updateCacheStatus();

            } catch (error) {
                console.error('Analysis error:', error);
                container.innerHTML = `<div style="color: red; text-align: center;">Error: ${error.message}</div>`;
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        // Clear cache button
        document.getElementById('clear-cache-btn').addEventListener('click', function() {
            api.clearCache();
            updateCacheStatus();
            alert('Cache cleared!');
        });

        // Show results summary
        function showResultsSummary(results, duration) {
            const summaryDiv = document.getElementById('results-summary');
            const successCount = Object.values(results.results || {})
                .filter(r => r.status === 'success').length;
            const totalCount = Object.keys(results.results || {}).length;

            summaryDiv.innerHTML = `
                <div class="results-summary">
                    <h2>Analysis Complete</h2>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-label">Fields Analyzed</span>
                            <span class="stat-value">${totalCount}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Successful</span>
                            <span class="stat-value">${successCount}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Query Type</span>
                            <span class="stat-value" style="font-size: 18px;">${currentQueryType}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Time Taken</span>
                            <span class="stat-value" style="font-size: 18px;">${duration}s</span>
                        </div>
                    </div>
                </div>
            `;
            summaryDiv.style.display = 'block';
        }

        // Update cache status
        function updateCacheStatus() {
            const stats = api.getCacheStats();
            document.getElementById('cache-status').textContent =
                `${stats.size} items cached (${Math.round(stats.memoryEstimate / 1024)}KB)`;
        }

        // Initial cache status
        updateCacheStatus();
    </script>
</body>
</html>