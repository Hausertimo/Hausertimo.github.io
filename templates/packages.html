{% extends "base.html" %}

{% block title %}Norm Database Packages - NormScout{% endblock %}

{% block nav_links %}
    <a href="/" class="nav-link">Home</a>
    <a href="/develop" class="nav-link">Develop</a>
    <a href="/dashboard" class="nav-link">Dashboard</a>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container">
        <!-- Header -->
        <div class="dashboard-welcome">
            <div class="welcome-header">
                <div>
                    <h1 class="dashboard-title">Expand Your Compliance Coverage</h1>
                    <p class="dashboard-subtitle">Rent access to specialized norm databases for your industry and region</p>
                </div>
            </div>
        </div>

        <!-- Savings Alert -->
        {% if savings_info and savings_info.should_upgrade %}
        <div style="background-color: #FFF3CD; border-left: 4px solid #FFC107; padding: 16px; margin-bottom: 24px; border-radius: 8px;">
            <p style="margin: 0; color: #856404;">
                <strong>ðŸ’° {{ savings_info.message }}</strong>
            </p>
        </div>
        {% endif %}

        <!-- Packages Grid -->
        <div class="dashboard-section">
            <h2 class="section-title">Available Packages</h2>

            <div class="workspaces-grid">
                {% for package_type, package in packages.items() %}
                <div class="workspace-card" style="{% if package_type in active_packages %}border-color: #4CAF50;{% elif package_type in trial_packages %}border-color: #2196F3;{% endif %}">
                    <!-- Icon & Status -->
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div style="font-size: 48px;">{{ package.icon }}</div>
                        {% if package_type in active_packages %}
                        <span style="background-color: #E8F5E9; color: #2E7D32; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 12px;">Active</span>
                        {% elif package_type in trial_packages %}
                        <span style="background-color: #E3F2FD; color: #1565C0; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 12px;">Trial</span>
                        {% endif %}
                    </div>

                    <!-- Package Info -->
                    <h3 style="font-size: 20px; margin-bottom: 8px;">{{ package.name }}</h3>
                    <p style="color: var(--text-light); font-size: 14px; margin-bottom: 16px;">{{ package.description }}</p>

                    <!-- Pricing -->
                    <div style="margin-bottom: 16px;">
                        <span style="font-size: 32px; font-weight: 700;">${{ (package.price / 100)|int }}</span>
                        <span style="color: var(--text-light);">/month</span>
                    </div>

                    <!-- Features -->
                    <ul style="list-style: none; padding: 0; margin-bottom: 20px;">
                        <li style="display: flex; align-items: start; margin-bottom: 8px; font-size: 14px;">
                            <span style="color: #4CAF50; margin-right: 8px;">âœ“</span>
                            <span>{{ package.norm_count }}+ norms</span>
                        </li>
                        {% for feature in package.features[:3] %}
                        <li style="display: flex; align-items: start; margin-bottom: 8px; font-size: 14px;">
                            <span style="color: #4CAF50; margin-right: 8px;">âœ“</span>
                            <span>{{ feature }}</span>
                        </li>
                        {% endfor %}
                    </ul>

                    <!-- CTA Buttons -->
                    {% if package_type in active_packages %}
                    <button class="btn" style="width: 100%; background-color: #E0E0E0; color: #757575; cursor: not-allowed;" disabled>
                        Currently Active
                    </button>
                    {% elif package_type in trial_packages %}
                    <button class="btn btn-accent" style="width: 100%;" onclick="purchasePackage('{{ package_type }}', false)">
                        Convert to Paid
                    </button>
                    {% else %}
                    <button class="btn btn-accent" style="width: 100%; margin-bottom: 8px;" onclick="purchasePackage('{{ package_type }}', false)">
                        Rent This Box
                    </button>
                    <button class="btn" style="width: 100%; background-color: white; color: var(--brand-blue); border: 2px solid var(--brand-blue);" onclick="purchasePackage('{{ package_type }}', true)">
                        Start {{ package.trial_days }}-Day Trial
                    </button>
                    {% endif %}

                    <!-- Preview Link -->
                    <a href="#" onclick="previewPackage('{{ package_type }}'); return false;" style="display: block; text-align: center; margin-top: 12px; font-size: 14px; color: var(--brand-blue); text-decoration: none;">
                        Preview sample norms â†’
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- How It Works Section -->
        <div class="dashboard-section" style="background-color: #F9F9F9; padding: 32px; border-radius: 12px; margin-top: 48px;">
            <h2 class="section-title">How It Works</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-top: 24px;">
                <div>
                    <h3 style="font-size: 18px; margin-bottom: 8px;">ðŸŽ¯ Choose Your Coverage</h3>
                    <p style="font-size: 14px; color: var(--text-light);">Select the database packages that match your products' markets and industries.</p>
                </div>
                <div>
                    <h3 style="font-size: 18px; margin-bottom: 8px;">âœ… Instant Access</h3>
                    <p style="font-size: 14px; color: var(--text-light);">After checkout, immediately analyze products with your new norm databases.</p>
                </div>
                <div>
                    <h3 style="font-size: 18px; margin-bottom: 8px;">ðŸ“Š Track Usage</h3>
                    <p style="font-size: 14px; color: var(--text-light);">Monitor which databases you're using most in your package dashboard.</p>
                </div>
                <div>
                    <h3 style="font-size: 18px; margin-bottom: 8px;">ðŸ”„ Cancel Anytime</h3>
                    <p style="font-size: 14px; color: var(--text-light);">No long-term commitments. Cancel or change packages whenever you need.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 32px; max-width: 800px; max-height: 90vh; overflow-y: auto; margin: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
            <h2 id="previewTitle" style="font-size: 24px; margin: 0;"></h2>
            <button onclick="closePreview()" style="background: none; border: none; font-size: 32px; cursor: pointer; color: var(--text-light);">&times;</button>
        </div>
        <div id="previewContent">
            <!-- Dynamic content loaded here -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
async function purchasePackage(packageType, isTrial = false) {
    try {
        const response = await fetch('/api/packages/purchase', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                package_type: packageType,
                is_trial: isTrial
            })
        });

        const data = await response.json();

        if (data.success) {
            // Redirect to Stripe checkout
            window.location.href = data.checkout_url;
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Purchase error:', error);
        alert('Failed to initiate checkout. Please try again.');
    }
}

async function previewPackage(packageType) {
    try {
        const response = await fetch(`/api/packages/${packageType}/preview`);
        const data = await response.json();

        if (data.success) {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const content = document.getElementById('previewContent');

            title.textContent = data.package.name + ' - Sample Norms';

            let html = `<p style="color: var(--text-light); margin-bottom: 20px;">Showing ${data.sample_norms.length} of ${data.total_norms} norms in this package</p>`;

            data.sample_norms.forEach(norm => {
                html += `
                    <div style="border: 1px solid #E0E0E0; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="font-size: 16px; margin-bottom: 8px;">${norm.id}: ${norm.name}</h3>
                        <p style="font-size: 14px; color: var(--text-light); margin-bottom: 4px;"><strong>Applies to:</strong> ${norm.applies_to}</p>
                        <p style="font-size: 14px; color: var(--text-light);">${norm.description}</p>
                    </div>
                `;
            });

            content.innerHTML = html;
            modal.style.display = 'flex';
        }
    } catch (error) {
        console.error('Preview error:', error);
        alert('Failed to load preview');
    }
}

function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
}
</script>
{% endblock %}
