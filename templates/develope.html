<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NormScout AI Workspace - Get instant EU compliance guidance and discover all applicable norms for your product">
    <title>Develope - NormScout AI Workspace</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/img/logo_icon.svg">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="AI Workspace - NormScout" />
    <meta property="og:description" content="Get instant EU compliance guidance and discover all applicable norms for your product with our AI-powered workspace." />
    <meta property="og:url" content="https://normscout.ch/develope" />
    <meta property="og:image" content="https://normscout.ch/img/logo_1200_630.png" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="NormScout" />

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="AI Workspace - NormScout" />
    <meta name="twitter:description" content="Get instant EU compliance guidance and discover all applicable norms for your product with our AI-powered workspace." />
    <meta name="twitter:image" content="https://normscout.ch/img/logo_1200_630.png" />

    <link rel="stylesheet" href="/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .develope-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 120px 1.5rem 3rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .page-header p {
            font-size: 1.125rem;
            color: var(--text-light);
        }

        .chat-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(56, 105, 250, 0.1);
        }

        .chat-messages {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            padding-right: 0.5rem;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--brand-blue);
            border-radius: 10px;
        }

        .message {
            margin-bottom: 1.25rem;
            padding: 1.25rem;
            border-radius: 12px;
            line-height: 1.6;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 3rem;
        }

        .message.assistant {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            margin-right: 3rem;
        }

        .message strong {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .message.user strong {
            color: rgba(255,255,255,0.9);
        }

        .message.assistant strong {
            color: var(--brand-blue);
        }

        .message.user p {
            color: white;
        }

        .input-group {
            display: flex;
            gap: 0.75rem;
            align-items: stretch;
        }

        .input-group input {
            flex: 1;
            padding: 1rem 1.25rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            font-family: var(--font-family);
            transition: all 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--brand-blue);
            box-shadow: 0 0 0 3px rgba(56, 105, 250, 0.1);
        }

        .input-group button {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--brand-blue) 0%, var(--royal-blue) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(56, 105, 250, 0.3);
        }

        .input-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(56, 105, 250, 0.4);
        }

        .input-group button:active {
            transform: translateY(0);
        }

        .input-group button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .results-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            padding: 2.5rem;
            display: none;
            border: 1px solid rgba(56, 105, 250, 0.1);
        }

        .results-container.visible {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .product-description {
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border-left: 4px solid var(--brand-blue);
        }

        .product-description h3 {
            color: var(--brand-blue);
            margin-bottom: 1rem;
        }

        .norm-item {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .norm-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .norm-item.clickable {
            cursor: pointer;
        }

        .norm-item.clickable * {
            pointer-events: none;
        }

        .norm-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
            gap: 1rem;
        }

        .norm-title {
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .confidence-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.35rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .confidence-badge.medium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .confidence-badge.low {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .norm-id {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .norm-reasoning {
            color: #4b5563;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: var(--brand-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .analyze-btn {
            display: block;
            width: 100%;
            padding: 1.25rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .analyze-btn:active {
            transform: translateY(0);
        }

        .analyze-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .analyze-btn.analyzing {
            background: #e5e7eb;
            cursor: wait;
        }

        .analyze-btn-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(135deg, var(--brand-blue) 0%, var(--royal-blue) 100%);
            width: 0%;
            transition: width 0.3s ease;
            z-index: 0;
        }

        .analyze-btn-text {
            position: relative;
            z-index: 1;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .analyze-btn.analyzing .analyze-btn-text {
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            animation: pulse-text 2s ease-in-out infinite;
        }

        @keyframes pulse-text {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.85;
            }
        }

        .results-container h2 {
            color: var(--text-dark);
            margin-bottom: 1.5rem;
        }

        .results-container h3 {
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        #normsCount {
            color: var(--brand-blue);
            font-weight: 700;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="/" class="logo">
                <img src="/img/full_logo.svg" alt="NormScout" class="logo-svg">
            </a>
            <nav class="nav">
                <a href="/contact" class="nav-link">Contact</a>
                <a href="/" class="btn btn-accent">Home</a>
            </nav>
        </div>
    </header>

    <div class="develope-container">
        <div class="page-header">
            <h1>AI Product Compliance Workspace</h1>
            <p>Get instant EU compliance guidance for your product</p>
        </div>

        <div class="chat-container">
            <div id="chatMessages" class="chat-messages">
                <div class="message assistant">
                    <strong>NormScout AI</strong>
                    <p>Welcome! Tell me about your product and I'll help identify all applicable EU compliance norms. Describe what you're making, and I'll ask follow-up questions if needed.</p>
                </div>
            </div>

            <div class="input-group">
                <input
                    type="text"
                    id="userInput"
                    placeholder="e.g., USB-powered LED desk lamp"
                    autocomplete="off"
                >
                <button id="sendBtn" onclick="sendMessage()">Send</button>
            </div>

            <button id="analyzeBtn" class="analyze-btn" onclick="analyzeNorms()" style="display: none;">
                <div class="analyze-btn-progress" id="analyzeBtnProgress"></div>
                <span class="analyze-btn-text" id="analyzeBtnText">Analyze Compliance Norms</span>
            </button>

            <button id="createWorkspaceBtn" class="analyze-btn" onclick="createWorkspace()" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-top: 1rem;">
                <span class="analyze-btn-text">üíæ Create Workspace</span>
            </button>
        </div>

        <div id="resultsContainer" class="results-container">
            <h2>Analysis Results</h2>

            <div id="productDescription" class="product-description"></div>

            <h3>Applicable Norms (<span id="normsCount">0</span>)</h3>
            <div id="normsList"></div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let conversationComplete = false;
        let analysisComplete = false;  // NEW - tracks if analysis is done

        // Send message on Enter key
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();

            if (!message) return;

            // Disable input
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;

            // Add user message to chat
            addMessage('user', message);
            input.value = '';

            try {
                // POST-ANALYSIS Q&A MODE
                if (analysisComplete) {
                    await askAnalysisQuestion(message);
                }
                // PRE-ANALYSIS CONVERSATION MODE
                else if (!sessionId) {
                    // Start new conversation
                    const response = await fetch('/api/develope/start', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({initial_input: message})
                    });

                    const data = await response.json();

                    if (data.error) {
                        addMessage('assistant', 'Error: ' + data.error);
                    } else {
                        sessionId = data.session_id;
                        addMessage('assistant', data.message);

                        if (data.complete) {
                            conversationComplete = true;
                            showAnalyzeButton();
                        }
                    }
                } else {
                    // Continue conversation
                    const response = await fetch('/api/develope/respond', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            session_id: sessionId,
                            message: message
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        addMessage('assistant', 'Error: ' + data.error);
                    } else {
                        addMessage('assistant', data.message);

                        if (data.complete) {
                            conversationComplete = true;
                            showAnalyzeButton();
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('assistant', 'Sorry, something went wrong. Please try again.');
            }

            // Re-enable input
            input.disabled = false;
            document.getElementById('sendBtn').disabled = false;
            input.focus();
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + role;

            const label = role === 'user' ? 'You' : 'NormScout AI';
            messageDiv.innerHTML = `<strong>${label}</strong><p>${content}</p>`;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showAnalyzeButton() {
            document.getElementById('analyzeBtn').style.display = 'block';
            document.getElementById('userInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
        }

        async function askAnalysisQuestion(question) {
            /**
             * Ask questions about completed analysis (POST-ANALYSIS Q&A)
             */
            try {
                const response = await fetch('/api/develope/ask-analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: sessionId,
                        question: question
                    })
                });

                const data = await response.json();

                if (data.error) {
                    addMessage('assistant', 'Error: ' + data.error);
                } else {
                    addMessage('assistant', data.answer);

                    // Optional: Highlight relevant norms if mentioned
                    if (data.relevant_norms && data.relevant_norms.length > 0) {
                        console.log('Relevant norms:', data.relevant_norms);
                    }
                }
            } catch (error) {
                console.error('Q&A Error:', error);
                addMessage('assistant', 'Sorry, I had trouble answering that question. Please try again.');
            }
        }

        async function analyzeNorms() {
            if (!sessionId || !conversationComplete) return;

            const analyzeBtn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('analyzeBtnText');
            const btnProgress = document.getElementById('analyzeBtnProgress');

            // Disable button and set analyzing state
            analyzeBtn.disabled = true;
            analyzeBtn.classList.add('analyzing');
            btnText.textContent = 'Starting analysis...';
            btnProgress.style.width = '0%';

            try {
                // Create EventSource for SSE
                const eventSource = new EventSource('/api/develope/analyze-stream?' + new URLSearchParams({
                    session_id: sessionId
                }));

                // Handle incoming progress updates
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);

                    if (data.phase === 'summary') {
                        btnText.textContent = data.status;
                        btnProgress.style.width = '5%';
                    }
                    else if (data.phase === 'analyzing') {
                        btnText.textContent = data.status;
                        // Map progress to 5-95% range
                        const progressPercent = 5 + ((data.progress / data.total) * 90);
                        btnProgress.style.width = progressPercent + '%';
                    }
                    else if (data.phase === 'finalizing') {
                        btnText.textContent = data.status;
                        btnProgress.style.width = '95%';
                    }
                    else if (data.phase === 'complete') {
                        btnText.textContent = 'Complete!';
                        btnProgress.style.width = '100%';
                        eventSource.close();

                        // Display results
                        displayResults(data);

                        // Reset button after a brief delay
                        setTimeout(() => {
                            analyzeBtn.classList.remove('analyzing');
                            analyzeBtn.disabled = false;
                            btnText.textContent = 'Analyze Compliance Norms';
                            btnProgress.style.width = '0%';
                        }, 1000);
                    }
                    else if (data.phase === 'error') {
                        eventSource.close();
                        alert('Error: ' + data.error);

                        // Reset button
                        analyzeBtn.classList.remove('analyzing');
                        analyzeBtn.disabled = false;
                        btnText.textContent = 'Analyze Compliance Norms';
                        btnProgress.style.width = '0%';
                    }
                };

                // Handle connection errors
                eventSource.onerror = function(error) {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    alert('Connection error during analysis. Please try again.');

                    // Reset button
                    analyzeBtn.classList.remove('analyzing');
                    analyzeBtn.disabled = false;
                    btnText.textContent = 'Analyze Compliance Norms';
                    btnProgress.style.width = '0%';
                };

            } catch (error) {
                console.error('Error:', error);
                alert('Sorry, something went wrong during analysis.');

                // Reset button
                analyzeBtn.classList.remove('analyzing');
                analyzeBtn.disabled = false;
                btnText.textContent = 'Analyze Compliance Norms';
                btnProgress.style.width = '0%';
            }
        }

        function displayResults(data) {
            // Show results container
            document.getElementById('resultsContainer').classList.add('visible');

            // Display product description with edit button
            const formattedDescription = formatProductDescription(data.product_description);

            document.getElementById('productDescription').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Product Description</h3>
                    <button onclick="editProductDescription()" class="edit-btn" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                        üìù Edit Description
                    </button>
                </div>
                <div id="productDescText" style="line-height: 1.8; color: var(--text-dark);" data-raw="${data.product_description.replace(/"/g, '&quot;')}">
                    ${formattedDescription}
                </div>
                <textarea id="productDescTextarea" style="display: none; width: 100%; min-height: 150px; padding: 0.75rem; border: 2px solid var(--brand-blue); border-radius: 8px; font-family: inherit; font-size: 0.95rem; resize: vertical; line-height: 1.6;"></textarea>
                <div id="editActions" style="display: none; margin-top: 1rem; gap: 0.5rem;">
                    <button onclick="saveProductDescription()" style="padding: 0.5rem 1.5rem; background: var(--brand-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Save Changes</button>
                    <button onclick="cancelEdit()" style="padding: 0.5rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                </div>
                <div id="regeneratePrompt" style="display: none; margin-top: 1rem; padding: 1rem; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px;">
                    <strong>‚ö†Ô∏è Product description modified</strong>
                    <p style="margin: 0.5rem 0 0 0;">The analysis results may be outdated. Click the button below to regenerate.</p>
                    <button onclick="regenerateAnalysis()" style="margin-top: 0.75rem; padding: 0.75rem 1.5rem; background: #ffc107; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üîÑ Regenerate Analysis</button>
                </div>
            `;

            // Display norms count
            document.getElementById('normsCount').textContent = data.total_norms;

            // Display norms
            const normsList = document.getElementById('normsList');
            normsList.innerHTML = '';

            if (data.norms.length === 0) {
                normsList.innerHTML = '<p>No applicable norms found.</p>';
            } else {
                data.norms.forEach(norm => {
                    const normDiv = document.createElement('div');
                    normDiv.className = 'norm-item';

                    let confidenceClass = 'high';
                    if (norm.confidence < 80) confidenceClass = 'medium';
                    if (norm.confidence < 60) confidenceClass = 'low';

                    normDiv.innerHTML = `
                        <div class="norm-header">
                            <div class="norm-title">${norm.norm_name} ${norm.url ? 'üîó' : ''}</div>
                            <div class="confidence-badge ${confidenceClass}">${norm.confidence}%</div>
                        </div>
                        <div class="norm-id">ID: ${norm.norm_id}</div>
                        <div class="norm-reasoning">${norm.reasoning}</div>
                    `;

                    // Make clickable if URL exists (AFTER setting innerHTML)
                    if (norm.url) {
                        normDiv.classList.add('clickable');
                        normDiv.onclick = () => window.open(norm.url, '_blank');
                        normDiv.title = 'Click to view official document';
                    }

                    normsList.appendChild(normDiv);
                });
            }

            // Scroll to results
            document.getElementById('resultsContainer').scrollIntoView({behavior: 'smooth'});

            // *** PHASE 1: RE-ENABLE CHAT FOR POST-ANALYSIS Q&A ***
            analysisComplete = true;

            // Re-enable input for Q&A
            document.getElementById('userInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('userInput').placeholder =
                "Ask questions about the analysis (e.g., 'Why does this norm apply?')";
            document.getElementById('userInput').focus();

            // Add separator message
            addMessage('assistant',
                '‚úì Analysis complete! Ask me questions about the results, or you can modify your product description and regenerate the analysis.');

            // *** PHASE 3: SHOW CREATE WORKSPACE BUTTON ***
            document.getElementById('createWorkspaceBtn').style.display = 'block';
        }

        // *** FORMAT PRODUCT DESCRIPTION ***
        function formatProductDescription(description) {
            if (!description) return '';

            try {
                let formatted = description;

                // Process headers FIRST (before modifying newlines)
                // Main headers (ALL CAPS followed by colon)
                formatted = formatted.replace(/^([A-Z\s]{3,}:)/gm, '<h4 style="color: var(--brand-blue); margin-top: 1.5rem; margin-bottom: 0.75rem; font-size: 1rem; font-weight: 700;">$1</h4>');

                // Section headers (numbered sections like "1. Product Classification")
                formatted = formatted.replace(/^(\d+\.\s+[A-Z][a-zA-Z\s&\/]+)/gm, '<h5 style="color: var(--text-dark); margin-top: 1rem; margin-bottom: 0.5rem; font-size: 0.95rem; font-weight: 600;">$1</h5>');
                // Section headers (Title Case followed by colon)
                formatted = formatted.replace(/^([A-Z][a-zA-Z\s&\/]+:)(?=\s*\n|$)/gm, '<h5 style="color: var(--text-dark); margin-top: 1rem; margin-bottom: 0.5rem; font-size: 0.95rem; font-weight: 600;">$1</h5>');

                // Process bullet points SECOND
                formatted = formatted.replace(/^\s*\*\s+(.+)$/gm, '<li>$1</li>');
                formatted = formatted.replace(/^\s*-\s+(.+)$/gm, '<li>$1</li>');

                // Wrap consecutive <li> elements in <ul> BEFORE converting newlines
                formatted = formatted.replace(/(<li>.*?<\/li>\n?)+/g, function(match) {
                    return '<ul style="margin: 0.5rem 0 1rem 1.5rem; padding-left: 1rem;">' + match + '</ul>';
                });

                // Convert newlines LAST
                formatted = formatted.replace(/\n\n+/g, '</p><p style="margin-bottom: 0.75rem;">');
                formatted = formatted.replace(/\n/g, '<br>');

                // Wrap in initial paragraph tag if needed
                if (!formatted.startsWith('<h4') && !formatted.startsWith('<h5') && !formatted.startsWith('<ul') && !formatted.startsWith('<p')) {
                    formatted = '<p style="margin-bottom: 0.75rem;">' + formatted + '</p>';
                }

                // Clean up empty paragraphs
                formatted = formatted.replace(/<p[^>]*>\s*<\/p>/g, '');

                return formatted;
            } catch (error) {
                console.error('Error formatting description:', error);
                return '<pre style="white-space: pre-wrap; font-family: inherit;">' + description + '</pre>';
            }
        }

        // *** PHASE 2: EDIT & REGENERATE FUNCTIONS ***
        let originalDescription = '';
        let needsRegeneration = false;

        function editProductDescription() {
            const textEl = document.getElementById('productDescText');
            const textareaEl = document.getElementById('productDescTextarea');
            const editActionsEl = document.getElementById('editActions');

            // Get raw text from data attribute
            originalDescription = textEl.getAttribute('data-raw');
            textareaEl.value = originalDescription;

            textEl.style.display = 'none';
            textareaEl.style.display = 'block';
            editActionsEl.style.display = 'flex';
        }

        function cancelEdit() {
            const textEl = document.getElementById('productDescText');
            const textareaEl = document.getElementById('productDescTextarea');
            const editActionsEl = document.getElementById('editActions');

            textEl.style.display = 'block';
            textareaEl.style.display = 'none';
            editActionsEl.style.display = 'none';
        }

        function saveProductDescription() {
            const textEl = document.getElementById('productDescText');
            const textareaEl = document.getElementById('productDescTextarea');
            const editActionsEl = document.getElementById('editActions');
            const regeneratePromptEl = document.getElementById('regeneratePrompt');

            const newDescription = textareaEl.value.trim();

            if (!newDescription) {
                alert('Product description cannot be empty');
                return;
            }

            if (newDescription !== originalDescription) {
                // Update both the raw data and formatted display
                textEl.setAttribute('data-raw', newDescription);
                textEl.innerHTML = formatProductDescription(newDescription);
                needsRegeneration = true;
                regeneratePromptEl.style.display = 'block';

                // Add overlay to dim results
                document.getElementById('normsList').style.opacity = '0.5';
                document.getElementById('normsList').style.pointerEvents = 'none';
            }

            textEl.style.display = 'block';
            textareaEl.style.display = 'none';
            editActionsEl.style.display = 'none';
        }

        async function regenerateAnalysis() {
            if (!needsRegeneration) return;

            const newDescription = document.getElementById('productDescText').textContent;
            const regeneratePromptEl = document.getElementById('regeneratePrompt');

            // Hide regenerate prompt
            regeneratePromptEl.style.display = 'none';

            // Reset results opacity
            document.getElementById('normsList').style.opacity = '1';
            document.getElementById('normsList').style.pointerEvents = 'auto';

            // Show analyze button with progress bar again
            const analyzeBtn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('analyzeBtnText');
            const btnProgress = document.getElementById('analyzeBtnProgress');

            analyzeBtn.disabled = true;
            analyzeBtn.classList.add('analyzing');
            btnText.textContent = 'Starting re-analysis...';
            btnProgress.style.width = '0%';
            analyzeBtn.style.display = 'block';

            try {
                // Create EventSource for SSE (reuse analyze logic)
                const eventSource = new EventSource('/api/develope/analyze-stream?' + new URLSearchParams({
                    session_id: sessionId
                }));

                // Update session with new description first (we'll do this in backend)
                // For now, rebuild summary with new description - actually, let's just re-run analysis
                // The backend will use the stored conversation history

                // Handle incoming progress updates (same as analyzeNorms)
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);

                    if (data.phase === 'summary') {
                        btnText.textContent = data.status;
                        btnProgress.style.width = '5%';
                    }
                    else if (data.phase === 'analyzing') {
                        btnText.textContent = data.status;
                        const progressPercent = 5 + ((data.progress / data.total) * 90);
                        btnProgress.style.width = progressPercent + '%';
                    }
                    else if (data.phase === 'finalizing') {
                        btnText.textContent = data.status;
                        btnProgress.style.width = '95%';
                    }
                    else if (data.phase === 'complete') {
                        btnText.textContent = 'Complete!';
                        btnProgress.style.width = '100%';
                        eventSource.close();

                        // Display new results
                        displayResults(data);

                        // Reset state
                        needsRegeneration = false;

                        // Hide button after a moment
                        setTimeout(() => {
                            analyzeBtn.style.display = 'none';
                            analyzeBtn.classList.remove('analyzing');
                            analyzeBtn.disabled = false;
                            btnText.textContent = 'Analyze Compliance Norms';
                            btnProgress.style.width = '0%';
                        }, 1000);
                    }
                    else if (data.phase === 'error') {
                        eventSource.close();
                        alert('Error: ' + data.error);

                        // Reset button
                        analyzeBtn.classList.remove('analyzing');
                        analyzeBtn.disabled = false;
                        btnText.textContent = 'Analyze Compliance Norms';
                        btnProgress.style.width = '0%';
                    }
                };

                eventSource.onerror = function(error) {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    alert('Connection error during re-analysis. Please try again.');

                    // Reset button
                    analyzeBtn.classList.remove('analyzing');
                    analyzeBtn.disabled = false;
                    btnText.textContent = 'Analyze Compliance Norms';
                    btnProgress.style.width = '0%';
                };

            } catch (error) {
                console.error('Error:', error);
                alert('Sorry, something went wrong during re-analysis.');

                // Reset button
                analyzeBtn.classList.remove('analyzing');
                analyzeBtn.disabled = false;
                btnText.textContent = 'Analyze Compliance Norms';
                btnProgress.style.width = '0%';
            }
        }

        // *** PHASE 3: CREATE WORKSPACE FUNCTION ***
        async function createWorkspace() {
            if (!analysisComplete) {
                alert('Please complete the analysis first');
                return;
            }

            const btn = document.getElementById('createWorkspaceBtn');
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<span class="analyze-btn-text">Creating workspace...</span>';

            try {
                const response = await fetch('/api/workspace/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({session_id: sessionId})
                });

                const data = await response.json();

                if (data.error) {
                    alert('Error creating workspace: ' + data.error);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                } else {
                    // Redirect to workspace page
                    window.location.href = data.url;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Sorry, something went wrong creating the workspace.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>
