{% extends "base.html" %}

{% block title %}AI Survey - NormScout{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 0;
    }

    .chat-container {
        max-width: 800px;
        margin: 0 auto;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: white;
        box-shadow: 0 0 40px rgba(0,0,0,0.2);
    }

    .chat-header {
        background: linear-gradient(135deg, #3869FA 0%, #2048D5 100%);
        color: white;
        padding: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chat-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
    }

    .chat-progress {
        font-size: 14px;
        opacity: 0.9;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 24px;
        display: flex;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user {
        justify-content: flex-end;
    }

    .message.assistant {
        justify-content: flex-start;
    }

    .message-bubble {
        max-width: 70%;
        padding: 16px 20px;
        border-radius: 16px;
        font-size: 15px;
        line-height: 1.5;
        position: relative;
    }

    .message.user .message-bubble {
        background: #3869FA;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.assistant .message-bubble {
        background: white;
        color: #333;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .message-timestamp {
        font-size: 11px;
        opacity: 0.6;
        margin-top: 6px;
    }

    .message.user .message-timestamp {
        text-align: right;
    }

    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 16px 20px;
        background: white;
        border-radius: 16px;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        max-width: fit-content;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: #666;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% {
            opacity: 0.3;
            transform: translateY(0);
        }
        30% {
            opacity: 1;
            transform: translateY(-10px);
        }
    }

    .chat-input-container {
        padding: 24px;
        background: white;
        border-top: 2px solid #e0e0e0;
    }

    .chat-input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        padding: 14px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 24px;
        font-size: 15px;
        font-family: 'Inter', sans-serif;
        resize: none;
        max-height: 120px;
        transition: all 0.2s;
    }

    .chat-input:focus {
        outline: none;
        border-color: #3869FA;
        box-shadow: 0 0 0 3px rgba(56, 105, 250, 0.1);
    }

    .send-button {
        background: #3869FA;
        color: white;
        border: none;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .send-button:hover:not(:disabled) {
        background: #2048D5;
        transform: scale(1.05);
    }

    .send-button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .completion-screen {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 64px 32px;
        text-align: center;
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .completion-screen.show {
        display: flex;
    }

    .completion-icon {
        font-size: 80px;
        margin-bottom: 24px;
    }

    .completion-title {
        font-size: 32px;
        font-weight: 700;
        color: #2048D5;
        margin-bottom: 16px;
    }

    .completion-message {
        font-size: 18px;
        color: #666;
        margin-bottom: 32px;
        max-width: 500px;
    }

    .error-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 64px 32px;
        text-align: center;
    }

    .error-icon {
        font-size: 64px;
        margin-bottom: 24px;
    }

    .error-title {
        font-size: 24px;
        font-weight: 700;
        color: #dc3545;
        margin-bottom: 16px;
    }

    @media (max-width: 768px) {
        .chat-container {
            max-width: 100%;
            border-radius: 0;
        }

        .message-bubble {
            max-width: 85%;
        }

        .chat-header {
            padding: 16px;
        }

        .chat-title {
            font-size: 20px;
        }

        .chat-messages {
            padding: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <div>
            <h1 class="chat-title" id="surveyTitle">AI Survey</h1>
            <div class="chat-progress" id="progressText">Starting...</div>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="chat-messages" id="messagesContainer">
        <!-- Messages will be added here -->
    </div>

    <!-- Completion Screen (hidden initially) -->
    <div class="completion-screen" id="completionScreen">
        <div class="completion-icon">üéâ</div>
        <h2 class="completion-title">Survey Completed!</h2>
        <p class="completion-message">
            Thank you for taking the time to complete this survey.
            Your responses have been recorded successfully.
        </p>
    </div>

    <!-- Input Container -->
    <div class="chat-input-container" id="inputContainer">
        <div class="chat-input-wrapper">
            <textarea
                id="messageInput"
                class="chat-input"
                placeholder="Type your response..."
                rows="1"
                maxlength="1000"
            ></textarea>
            <button id="sendButton" class="send-button" onclick="sendMessage()">
                ‚û§
            </button>
        </div>
    </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const surveyId = urlParams.get('id');
let responseId = null;
let isWaitingForResponse = false;
let currentSurvey = null;

// Get URL parameter
if (!surveyId) {
    document.querySelector('.chat-container').innerHTML = `
        <div class="error-screen">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2 class="error-title">Survey Not Found</h2>
            <p>No survey ID provided in the URL.</p>
        </div>
    `;
}

// Initialize survey
async function initializeSurvey() {
    try {
        // Load survey
        const surveyResponse = await fetch(`/api/surveys/${surveyId}`);
        if (!surveyResponse.ok) {
            throw new Error('Survey not found or inactive');
        }
        currentSurvey = await surveyResponse.json();

        document.getElementById('surveyTitle').textContent = currentSurvey.name;
        updateProgress(0, currentSurvey.topics.length);

        // Start survey response
        const startResponse = await fetch(`/api/surveys/${surveyId}/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });

        const data = await startResponse.json();
        if (!data.success) {
            throw new Error(data.error || 'Failed to start survey');
        }

        responseId = data.response_id;

        // Add first AI message
        addMessage('assistant', data.message);

    } catch (error) {
        console.error('Failed to initialize survey:', error);
        document.querySelector('.chat-container').innerHTML = `
            <div class="error-screen">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h2 class="error-title">Error Loading Survey</h2>
                <p>${error.message}</p>
            </div>
        `;
    }
}

// Add message to chat
function addMessage(role, content) {
    const container = document.getElementById('messagesContainer');

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = content;

    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    bubble.appendChild(timestamp);
    messageDiv.appendChild(bubble);
    container.appendChild(messageDiv);

    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

// Show typing indicator
function showTypingIndicator() {
    const container = document.getElementById('messagesContainer');

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message assistant';
    messageDiv.id = 'typingIndicator';

    const typing = document.createElement('div');
    typing.className = 'typing-indicator';
    typing.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
    `;

    messageDiv.appendChild(typing);
    container.appendChild(messageDiv);

    container.scrollTop = container.scrollHeight;
}

// Remove typing indicator
function removeTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) {
        indicator.remove();
    }
}

// Update progress
function updateProgress(current, total) {
    const progressText = document.getElementById('progressText');
    progressText.textContent = `Topic ${current + 1} of ${total}`;
}

// Send message
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message || isWaitingForResponse) {
        return;
    }

    // Add user message
    addMessage('user', message);
    input.value = '';
    input.style.height = 'auto';

    // Disable input
    isWaitingForResponse = true;
    input.disabled = true;
    document.getElementById('sendButton').disabled = true;

    // Show typing
    showTypingIndicator();

    try {
        const response = await fetch(`/api/responses/${responseId}/message`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        // Remove typing
        removeTypingIndicator();

        if (!data.success) {
            throw new Error(data.error || 'Failed to send message');
        }

        // Add AI response
        addMessage('assistant', data.message);

        // Update progress
        if (currentSurvey && data.current_topic_index !== undefined) {
            updateProgress(data.current_topic_index, currentSurvey.topics.length);
        }

        // Check if completed
        if (data.completed) {
            showCompletionScreen();
        } else {
            // Re-enable input
            input.disabled = false;
            document.getElementById('sendButton').disabled = false;
            input.focus();
        }

    } catch (error) {
        removeTypingIndicator();
        addMessage('assistant', 'Sorry, something went wrong. Please try again.');
        input.disabled = false;
        document.getElementById('sendButton').disabled = false;
    }

    isWaitingForResponse = false;
}

// Show completion screen
function showCompletionScreen() {
    document.getElementById('messagesContainer').style.display = 'none';
    document.getElementById('inputContainer').style.display = 'none';
    document.getElementById('completionScreen').classList.add('show');
}

// Handle Enter key
document.getElementById('messageInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Auto-resize textarea
document.getElementById('messageInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    if (surveyId) {
        initializeSurvey();
    }
});
</script>
{% endblock %}
