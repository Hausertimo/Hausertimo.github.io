{% extends "base.html" %}

{% block title %}My Packages - NormScout{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">My Norm Database Packages</h1>
            <p class="text-gray-600">Manage your subscriptions and view usage statistics</p>
        </div>

        <!-- Active Packages -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Active Subscriptions</h2>

            {% if active_packages %}
            <div class="grid md:grid-cols-2 gap-6">
                {% for package in active_packages %}
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-3xl mb-2">{{ package.config.icon }}</div>
                            <h3 class="text-xl font-bold">{{ package.config.name }}</h3>
                            <p class="text-sm text-gray-600">{{ package.config.description }}</p>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded">Active</span>
                    </div>

                    <div class="space-y-2 mb-4">
                        <p class="text-sm"><strong>Activated:</strong> {{ package.activated_at[:10] if package.activated_at else 'N/A' }}</p>
                        {% if package.expires_at %}
                        <p class="text-sm"><strong>Renews:</strong> {{ package.expires_at[:10] }}</p>
                        {% endif %}
                        <p class="text-sm"><strong>Price:</strong> ${{ (package.config.price / 100)|int }}/month</p>
                        <p class="text-sm"><strong>Databases:</strong> {{ package.config.databases|length if package.config.databases != 'all' else 'All databases' }}</p>
                    </div>

                    <button onclick="cancelPackage('{{ package.package_type }}')" class="w-full bg-red-100 text-red-700 hover:bg-red-200 font-semibold py-2 px-4 rounded">
                        Cancel Subscription
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-gray-50 rounded-lg p-8 text-center">
                <p class="text-gray-600 mb-4">You don't have any active packages yet.</p>
                <a href="/packages" class="inline-block bg-blue-600 text-white font-semibold py-2 px-6 rounded hover:bg-blue-700">
                    Browse Packages
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Trial Packages -->
        {% if trial_packages %}
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Trial Subscriptions</h2>
            <div class="grid md:grid-cols-2 gap-6">
                {% for package in trial_packages %}
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-3xl mb-2">{{ package.config.icon }}</div>
                            <h3 class="text-xl font-bold">{{ package.config.name }}</h3>
                            <p class="text-sm text-gray-600">{{ package.config.description }}</p>
                        </div>
                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">Trial</span>
                    </div>

                    <div class="space-y-2 mb-4">
                        <p class="text-sm"><strong>Trial started:</strong> {{ package.trial_start[:10] if package.trial_start else 'N/A' }}</p>
                        {% if package.trial_end %}
                        <p class="text-sm"><strong>Trial ends:</strong> {{ package.trial_end[:10] }}</p>
                        {% endif %}
                    </div>

                    <a href="/packages" class="block w-full bg-blue-600 text-white text-center font-semibold py-2 px-4 rounded hover:bg-blue-700">
                        Convert to Paid
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Usage Statistics -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Usage Statistics (Last 30 Days)</h2>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600">{{ usage_stats.total_accesses }}</div>
                        <div class="text-sm text-gray-600">Total Analyses</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-600">{{ usage_stats.databases_used }}</div>
                        <div class="text-sm text-gray-600">Databases Used</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-purple-600">{{ allowed_databases|length }}</div>
                        <div class="text-sm text-gray-600">Available Databases</div>
                    </div>
                </div>

                {% if usage_stats.by_database %}
                <div>
                    <h3 class="font-semibold mb-3">Usage by Database</h3>
                    <div class="space-y-2">
                        {% for db_name, count in usage_stats.by_database.items() %}
                        <div class="flex justify-between items-center">
                            <span class="text-sm">{{ db_name.replace('norms_', '').replace('.json', '').upper() }}</span>
                            <div class="flex items-center">
                                <div class="w-48 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ (count / usage_stats.total_accesses * 100)|int }}%"></div>
                                </div>
                                <span class="text-sm font-semibold">{{ count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <p class="text-gray-600 text-center">No usage data yet. Start analyzing products to see statistics!</p>
                {% endif %}
            </div>
        </div>

        <!-- Available Databases -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Your Available Databases</h2>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="grid md:grid-cols-3 gap-3">
                    {% for db in allowed_databases %}
                    <div class="flex items-center bg-green-50 rounded px-3 py-2">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-sm font-medium">{{ db.replace('norms_', '').replace('.json', '').upper() }}</span>
                    </div>
                    {% endfor %}
                </div>

                <div class="mt-4 text-center">
                    <a href="/packages" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                        Add more databases â†’
                    </a>
                </div>
            </div>
        </div>

        <!-- Expired Packages -->
        {% if expired_packages %}
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Expired Subscriptions</h2>
            <div class="bg-gray-50 rounded-lg p-4">
                <ul class="space-y-2">
                    {% for package in expired_packages %}
                    <li class="flex justify-between items-center">
                        <div>
                            <span class="font-medium">{{ package.config.name }}</span>
                            <span class="text-sm text-gray-600 ml-2">Expired: {{ package.cancelled_at[:10] if package.cancelled_at else 'N/A' }}</span>
                        </div>
                        <a href="/packages" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">Reactivate</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
async function cancelPackage(packageType) {
    const reason = prompt('Are you sure you want to cancel? Please tell us why (optional):');

    if (reason !== null) { // User clicked OK (even if empty)
        try {
            const response = await fetch('/api/packages/cancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    package_type: packageType,
                    reason: reason || 'No reason provided'
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Subscription cancelled successfully.');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Cancel error:', error);
            alert('Failed to cancel subscription. Please try again.');
        }
    }
}
</script>
{% endblock %}
